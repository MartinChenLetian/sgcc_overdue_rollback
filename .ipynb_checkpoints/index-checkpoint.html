<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>国家电网 - 欠费撤回中心</title>
    <style>
        :root { --sgcc-green: #008573; }
        body { background: #f0f4f3; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-top: 10px solid var(--sgcc-green); border-radius: 8px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 320px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--sgcc-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #msg { color: #666; line-height: 1.6; }
        .success-icon { color: var(--sgcc-green); font-size: 60px; display: none; }
    </style>
</head>
<body>
    <div class="card">
        <div id="loader" class="spinner"></div>
        <div id="icon" class="success-icon">✓</div>
        <h1 id="title">正在处理请求...</h1>
        <p id="msg">请稍候，系统正在回滚数据库记录</p>
    </div>

    <script>
        async function doRollback() {
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const token = params.get('token');
            const apiUrl = `https://unywsopjpnerbgmgqqdg.supabase.co/functions/v1/monthly-overdue-updater/rollback/${action}?token=${token}`;

            try {
                const res = await fetch(apiUrl, { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'success') {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('icon').style.display = 'block';
                    document.getElementById('title').innerText = '撤回成功';
                    document.getElementById('msg').innerText = `已成功恢复 ${data.affected_rows} 条数据。`;
                } else {
                    throw new Error(data.message);
                }
            } catch (err) {
                document.getElementById('title').innerText = '操作失败';
                document.getElementById('msg').innerText = err.message;
            }
        }
        window.onload = doRollback;
    </script>
</body>
</html>