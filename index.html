<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>TERMINAL_SESSION_INIT</title>
    <style>
        :root {
            --terminal-green: #00ffa2;
            --terminal-bg: #050d0c;
            --error-red: #ff3e3e;
            --cursor-bg: #00ffa2;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--terminal-bg);
            color: var(--terminal-green);
            font-family: "Lucida Console", "Consolas", Monaco, monospace;
            margin: 0; padding: 25px;
            font-size: 18px; line-height: 1.5;
            min-height: 100vh; overflow-x: hidden;
            word-break: break-all;
        }

        /* CRT 屏幕特效 */
        body::after {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 1000; background-size: 100% 3px, 3px 100%; pointer-events: none;
        }

        #terminal-history { display: inline; }

        .line { margin-bottom: 4px; min-height: 1.5em; }
        .sys-dim { color: rgba(0, 255, 162, 0.4); font-size: 14px; }
        .success { color: #fff; text-shadow: 0 0 8px var(--terminal-green); }
        .error { color: var(--error-red); }

        /* 输入行样式 */
        #input-row { display: inline-flex; width: 100%; align-items: flex-start; }
        #prompt { white-space: nowrap; margin-right: 8px; color: #fff; font-weight: bold; }
        
        #cli {
            background: transparent; border: none; color: var(--terminal-green);
            font-family: inherit; font-size: inherit; outline: none;
            flex: 1; padding: 0; margin: 0;
            caret-color: var(--cursor-bg); /* 模拟光标 */
        }

        /* 禁止选择 */
        body { user-select: none; -webkit-user-select: none; cursor: default; }
        
        /* 隐藏滚动条 */
        ::-webkit-scrollbar { width: 0; }
    </style>
</head>
<body oncontextmenu="return false" onselectstart="return false">

    <div id="output">
        <div id="terminal-history"></div>
        <div id="input-row" style="display: none;">
            <span id="prompt"></span>
            <input type="text" id="cli" autofocus autocomplete="off" 
                   autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
    </div>

<script>
    const TARGET = "我已确认撤销自动上传的数据";
    const history = document.getElementById('terminal-history');
    const inputRow = document.getElementById('input-row');
    const cli = document.getElementById('cli');
    const promptEl = document.getElementById('prompt');

    // 1. 系统环境识别
    const isWin = navigator.userAgent.toUpperCase().indexOf('WINDOWS') > -1;
    const promptStr = isWin ? "C:\\Users\\Administrator> " : "root@sgcc-gateway:~# ";
    const cmdError = isWin ? "'{cmd}' 不是内部或外部命令，也不是可运行的程序。" : "zsh: command not found: {cmd}";
    promptEl.innerText = promptStr;

    // 2. 封杀所有干扰快捷键
    window.addEventListener('keydown', (e) => {
        // 阻止 F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S
        if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.keyCode === 85) || (e.ctrlKey && e.keyCode === 83)) {
            e.preventDefault();
            return false;
        }
    }, false);

    // 保持焦点
    document.body.addEventListener('click', () => cli.focus());

    // 3. 初始化闪烁序列
    const bootSequence = [
        { t: "[ BIOS ] Version 2.19.1242. (C) 2026 SGCC Energy.", s: 0, class: "sys-dim" },
        { t: "[ OK ] CPU: ARM v9 Neoverse-V2 Cluster detected.", s: 200, class: "sys-dim" },
        { t: "[ OK ] MEMORY: 128GB ECC-RAM Initialized.", s: 100, class: "sys-dim" },
        { t: "[ OK ] NETWORK: Remote Node SG-NUS-LINK Active.", s: 300, class: "sys-dim" },
        { t: " ", s: 100 },
        { t: "SGCC Secure Terminal (Session: " + Math.random().toString(36).substring(2, 10).toUpperCase() + ")", s: 100, class: "success" },
        { t: "Last Login: " + new Date().toLocaleString() + " from 172.19.0.42", s: 100 },
        { t: "--------------------------------------------------", s: 100 },
        { t: "> CRITICAL: 数据回滚授权待定。", s: 400 },
        { t: "> 请输入确认短句以验证身份:", s: 100 },
        { t: "> \"我已确认撤销自动上传的数据\"", s: 100, class: "success" },
        { t: " ", s: 200 }
    ];

    async function initTerminal() {
        for (const line of bootSequence) {
            await new Promise(r => setTimeout(r, line.s));
            const div = document.createElement('div');
            div.className = "line " + (line.class || "");
            div.innerText = line.t;
            history.appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
        }
        inputRow.style.display = "inline-flex";
        cli.focus();
    }

    // 4. 输入交互逻辑
    cli.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
            const val = cli.value.trim();
            
            // 将当前输入存入历史
            const historyLine = document.createElement('div');
            historyLine.className = "line";
            historyLine.innerHTML = `<span style="color:#fff;font-weight:bold;">${promptStr}</span>${val}`;
            history.appendChild(historyLine);
            
            cli.value = "";
            inputRow.style.display = "none";

            if (val === TARGET) {
                await executeRollback();
            } else if (val !== "") {
                const errLine = document.createElement('div');
                errLine.className = "line error";
                errLine.innerText = cmdError.replace("{cmd}", val);
                history.appendChild(errLine);
                inputRow.style.display = "inline-flex";
            } else {
                inputRow.style.display = "inline-flex";
            }
            window.scrollTo(0, document.body.scrollHeight);
        }
    });

    async function executeRollback() {
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');
        const id = params.get('id');

        const log = (text, cls = "") => {
            const d = document.createElement('div');
            d.className = "line " + cls;
            d.innerText = text;
            history.appendChild(d);
            window.scrollTo(0, document.body.scrollHeight);
        };

        log("\n[ PROCESS ] 授权码验证中...");
        await new Promise(r => setTimeout(r, 800));
        log("[ PROCESS ] 正在穿透边缘网关...");
        await new Promise(r => setTimeout(r, 600));

        try {
            const res = await fetch(`https://unywsopjpnerbgmgqqdg.supabase.co/functions/v1/monthly-overdue-updater/rollback/${action}?id=${id}`);
            const data = await res.json();

            if (data.status === 'success') {
                log("\n-------------------------------------------");
                log(">>> ACCESS GRANTED", "success");
                log(`> 数据库操作已撤回 (受影响行数: ${data.affected_rows})`);
                log(`> 任务 ID: ${id.split('-')[0]} 已作废`);
                log("> Session Closed. 安全退出中...");
                log("-------------------------------------------");
            } else {
                throw new Error(data.message || "REJECTED_BY_SERVER");
            }
        } catch (err) {
            log(`\n[ FATAL ] 执行中止: ${err.message}`, "error");
            log("> 请联系系统管理员或重新发起同步流程。", "sys-dim");
            inputRow.style.display = "inline-flex";
        }
    }

    window.onload = initTerminal;
</script>
</body>
</html>