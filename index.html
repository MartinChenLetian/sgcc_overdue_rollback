<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGCC | 能源数据回滚终端</title>
    <style>
        :root {
            --sgcc-neon: #00ffa2;
            --sgcc-dark: #050d0c;
            --error-red: #ff3e3e;
            --terminal-green: rgba(0, 255, 162, 0.7);
        }

        body {
            background-color: var(--sgcc-dark);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(0, 133, 115, 0.1) 0%, transparent 80%),
                linear-gradient(rgba(0, 255, 162, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 162, 0.02) 1px, transparent 1px);
            background-size: 100% 100%, 20px 20px, 20px 20px;
            font-family: "SF Mono", "Monaco", "Consolas", "Microsoft YaHei", monospace;
            margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; overflow: hidden;
        }

        .terminal-card {
            background: rgba(8, 20, 18, 0.95);
            padding: 40px;
            border: 1px solid rgba(0, 255, 162, 0.3);
            position: relative;
            text-align: center;
            width: 320px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        /* 顶部装饰条 */
        .terminal-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: repeating-linear-gradient(90deg, var(--sgcc-neon), var(--sgcc-neon) 10px, transparent 10px, transparent 20px);
            opacity: 0.6;
        }

        /* 强制着色 SVG Logo */
        .logo-box {
            width: 180px; height: 60px; margin: 0 auto 30px;
            background-color: var(--sgcc-neon);
            /* 将图片作为遮罩，这样背景色(荧光绿)就会填充图片形状 */
            -webkit-mask: url('./state-grid.svg') no-repeat center / contain;
            mask: url('./state-grid.svg') no-repeat center / contain;
            filter: drop-shadow(0 0 8px var(--sgcc-neon));
        }

        .spinner {
            width: 30px; height: 30px; border: 1px solid var(--sgcc-neon);
            border-top-color: transparent; border-radius: 50%;
            margin: 20px auto; animation: spin 0.8s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* 状态显示优化 */
        .status-tag {
            display: inline-block; padding: 4px 12px; font-size: 10px; font-weight: bold;
            letter-spacing: 2px; border: 1px solid; margin-bottom: 20px; text-transform: uppercase;
        }
        .tag-success { color: var(--sgcc-neon); border-color: var(--sgcc-neon); background: rgba(0, 255, 162, 0.1); }
        .tag-error { color: var(--error-red); border-color: var(--error-red); background: rgba(255, 62, 62, 0.1); }

        h1 { font-size: 16px; letter-spacing: 3px; color: #fff; margin: 10px 0; font-weight: normal; }
        #msg { color: var(--terminal-green); font-size: 11px; line-height: 1.8; text-align: left; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 4px; min-height: 60px; }

        .footer { margin-top: 30px; font-size: 9px; color: rgba(0, 255, 162, 0.3); letter-spacing: 2px; }
    </style>
</head>
<body>
    <div class="terminal-card">
        <div class="terminal-header"></div>
        
        <div class="logo-box" id="logo"></div>

        <div id="loader" class="spinner"></div>
        
        <div id="status_tag" style="display:none;" class="status-tag"></div>

        <h1 id="title">SYS_INITIALIZING...</h1>
        <div id="msg">> _正在连接远程电力调度节点...</div>

        <div class="footer">ST-GRID RECOVERY UNIT // 2.0</div>
    </div>

    <script>
        async function runRollback() {
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const id = params.get('id');
            const tag = document.getElementById('status_tag');
            const msg = document.getElementById('msg');
            const title = document.getElementById('title');

            if (!id || !action) {
                updateUI("tag-error", "[ PARAM_MISSING ]", "ERR_ID_NOT_FOUND", "> 无法解析有效的 UUID 凭证。");
                return;
            }

            try {
                await new Promise(r => setTimeout(r, 1000)); // 模拟预检
                const apiUrl = `https://unywsopjpnerbgmgqqdg.supabase.co/functions/v1/monthly-overdue-updater/rollback/${action}?id=${id}`;
                const res = await fetch(apiUrl);
                const data = await res.json();
                
                if (data.status === 'success') {
                    updateUI("tag-success", "[ ACCESS_GRANTED ]", "ROLLBACK_SUCCESS", `> 远程指令校验成功。<br>> 受影响记录: ${data.affected_rows}<br>> 凭证生命周期已终止。`);
                } else {
                    throw new Error(data.message || "REMOTE_REJECTED");
                }
            } catch (err) {
                updateUI("tag-error", "[ AUTH_FAILURE ]", "DECRYPTION_FAILED", `> 拒绝访问: ${err.message}`);
            }
        }

        function updateUI(className, tagText, titleText, msgHtml) {
            document.getElementById('loader').style.display = 'none';
            const tag = document.getElementById('status_tag');
            tag.style.display = 'inline-block';
            tag.className = 'status-tag ' + className;
            tag.innerText = tagText;
            document.getElementById('title').innerText = titleText;
            document.getElementById('msg').innerHTML = msgHtml;
        }

        window.onload = runRollback;
    </script>
</body>
</html>